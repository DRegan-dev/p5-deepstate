{% extends 'base.html' %}

{% load static %}

{% block page_header %}
    <div class="container header-container">
        <div class="row">
            <div class="col" role="region" aria-label="Basket header"></div>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="overlay"></div>
    <div class="container my-4" role="main">
        <div class="row">
            <div class="col">
                <hr>
                <h2 class="mb-4 text-white">Shopping Basket</h2>
                <hr>
            </div>
        </div>
        <div class="row">
            <div class="col">
                {% if basket_items %}
                    <div class="table-responsive rounded">
                        <table class="table table-sm table-borderless bg-white" aria-label="Shopping basket items">
                            <thead class="text-black">
                                <tr>
                                    <th scope="col">Product Info</th>
                                    <th scope="col"></th>
                                    <th scope="col">Price</th>
                                    <th scope="col">Quantity</th>
                                    <th scope="col">Subtotal</th>   
                                </tr>
                            </thead>
                            {% for item in basket_items %}
                                <tr>
                                    <td class="p-3 w-25">
                                        <img src="{{ item.product.image.url }}" alt="" class="img-fluid rounded" loading="lazy">
                                    </td>
                                    <td class="py-3">
                                        <p class="my-0"><strong>{{ item.product.name }}</strong></p>
                                        {% if item.product.has_sizes %}
                                            <p class="my-0"><strong>Size:</strong>{{ item.size|upper }}</p>
                                         {% endif %}
                                        <p class="my-0 small text-muted">SKU: {{ item.product.sku|upper }}</p>
                                    </td>
                                    <td class="py-3">
                                        <p class="my-0">${{ item.product.price }}</p>
                                    </td>
                                    <td class="py-3 w-25">
                                        <p class="my-0">{{ item.quantity }}</p>
                                    </td>
                                    <td class="py-3">
                                        <p class="my-0">${{ item.product.price }}</p>
                                    </td>
                                    <td class="py-3 w-25">
                                        <form method="POST" class="form update-form" action="{% url 'basket:adjust_basket' item.item_id %}">
                                            {% csrf_token %}
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <button  type="button" class="quantity-decrease btn btn-outline-secondary btn-dark" data-item_id="{{ item.item_id }}" id="decrement-qty_{{ item.item_id }}">
                                                        <i class="fas fa-minus small"></i>
                                                    </button>

                                                    <input type="number" class="form-control w-20text-center qty-input text-dark"
                                                        name="quantity" value="{{ item.quantity }}" min="1" max="99"
                                                        id="id_qty_{{ item.item_id }}">

                                                    <button class="quantity-increase btn btn-outline-secondary btn-dark"
                                                        data-item_id="{{ item.item_id }}" id="increment-qty_{{ item.item_id }}">
                                                        <span>
                                                            <i class="fas fa-plus fa-sm"></i>
                                                        </span>
                                                    </button>

                                                    {% if item.product.has_sizes %}
                                                        <input type="hidden" name="product_size" value="{{ item.size }}">
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </form>
                                        <a class="update-link text-info" aria-label="Update quantitiy for {{ item.product.name }}"><small>Update</small></a>
                                        <a class="remove-item text-danger float-right" id="remove_{{ item.item_id }}" data-size="{{ item.size }}" aria-label="Remove {{ item.product.name }} from basket"><small>Remove</small></a>
                                    </td>
                                </tr> 
                            {% endfor %}
                            <tr>
                                <td colspan="5" class="pt-5 text-end">
                                    <h6><strong>Basket Total: ${{ total|floatformat:2 }}</strong></h6>
                                    <h6>Delivery: ${{ delivery|floatformat:2 }}</h6>
                                    <h4 class="mt-4"><strong>Grand Total: ${{ grand_total|floatformat:2 }}</strong></h4>
                                    {% if free_delivery_delta > 0 %}
                                        <p class="mb-1 text-danger" aria-live="polite">
                                            You could get free delivery by spending just ${{ free_delivery_delta }} more! 
                                        </p>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td colspan="5" class="text-end">
                                    <a href="{% url 'products:products' %}" class="btn btn-outline-dark rounded-0 btn-lg">
                                        <span class="icon">
                                            <i class="fas fa-chevron-left"></i>
                                        </span>
                                        <span class="text-uppercase">Keep Shopping</span>
                                    </a>

                                    <a {% if not user.is_authenticated %} href="{% url 'accounts:login' %}" {% else %} href="{% url 'checkout:checkout' %}" {% endif %} class="btn btn-dark rounded-0 btn-lg">
                                        <span class="text-uppercase">Secure Checkout</span>
                                        <span class="icon">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                    </a>
                                </td>
                            </tr>
                        </table>
                    </div>
                {% else %}
                    <p class="lead mb-5 text-white">Your basket is empty.</p>
                    <a href="{% url 'products:products' %}" class="btn btn-outline-black rounded-0 btn-lg" aria-label="Continue Shopping">
                        <span class="icon">
                            <i class="fas fa-chevron-left"></i>
                        </span>
                        <span class="text-uppercase text-white">Keep Shopping</span>
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block postloadjs %}
{{ block.super }}
{% include 'products/includes/quantity_input_script.html' %}

<script type="text/javascript">
    // Update quantity 
    document.querySelectorAll('.update-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const form = this.previousElementSibling;
            if (form && form.classList.contains('update-form')) {
                form.submit();
            }
        });
    });

    // Remove item 
    document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const csrfToken = "{{ csrf_token }}";
            const itemId = this.id.split('remove_')[1];
            const size = this.dataset.size;
            console.log('Attempting')
            const url = "{% url 'basket:remove_from_basket' '0' %}".replace('0', itemId)
            console.log('URL:', url);

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: new URLSearchParams({ size: size })
            })
            .then(response => {
                if(response.ok) {
                    location.reload();
                } else {
                    throw new Error('Failed to remove item');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to remove item. Please try again.')
            });
        });
    });
</script>
{% endblock %}